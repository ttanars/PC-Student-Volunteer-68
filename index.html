<!DOCTYPE html>
<html lang="th">
<head>
   <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC|Student Volunteer'68 v1</title> <link rel="shortcut icon" type="image/png" href="https://img2.pic.in.th/pic/Pakchong_School-removebg-preview.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.bootstrap5.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Niramit:wght@400;700&display=swap');
        body {
            background-color: #f0f2f5;
            font-family: 'Niramit', sans-serif;
        }
        .card {
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: none;
        }
        #clock {
            font-size: 1.1rem;
            font-weight: bold;
        }
        .signature-pad-container {
            border: 2px dashed #ced4da;
            border-radius: 0.5rem;
            position: relative;
        }
        .signature-pad-container.is-invalid {
            border-color: #dc3545;
        }
        #signature-pad {
            width: 100%;
            height: 200px;
            display: block;
        }
        .student-avatar, .search-student-avatar {
            width: 45px; height: 45px;
            border-radius: 50%;
            object-fit: cover;
            transition: transform 0.2s ease-in-out;
        }
        .student-avatar:hover, .search-student-avatar:hover {
            transform: scale(2.5);
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10;
            position: relative;
        }
        .stats-student-avatar {
            width: 50px; height: 50px;
            border-radius: 50%;
            object-fit: cover;
            transition: transform 0.2s ease-in-out;
            position: relative;
        }
        .stats-student-avatar:hover {
            transform: scale(1.5);
            cursor: pointer;
            z-index: 1050;
            transform-origin: 0% 0%;
        }
        .history-activity-image {
            width: 60px;
            height: 60px;
            border-radius: 0.25rem;
            object-fit: cover;
            transition: transform 0.2s ease-in-out;
            position: relative;
        }
        .history-activity-image:hover {
            transform: scale(2.5);
            cursor: pointer;
            z-index: 10;
        }
        .teacher-info img {
            width: 80px; height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .app-banner {
            width: 100%;
            max-height: 290px;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .nav-tabs .nav-link {
            font-weight: bold; color: #6c757d; border-bottom-width: 2px;
        }
        .nav-tabs .nav-link.active {
            color: #fff;
            background-color: #0d6efd;
            border-color: #0d6efd #0d6efd #0d6efd;
        }
        .tab-content {
            border: 1px solid #dee2e6; border-top: 0;
            padding: 1.5rem;
            border-radius: 0 0 0.5rem 0.5rem;
            background-color: #fff;
        }
        #statsTable thead th, #historyTable thead th, #searchSummaryTable thead th, #searchHistoryTable thead th {
            background-color: #212529 !important;
            color: #fff !important;
        }
        .dt-buttons { text-align: center; }
        .dt-buttons .btn { margin: 0 2px; }
        .student-info-card {
            background-color: #e9ecef;
            border-radius: 0.75rem;
        }
    </style>
</head>
<body>

<div id="app" class="container-fluid my-2">
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="text-center">
                <img src="https://lh4.googleusercontent.com/d/1Fnpl6RKu3FFh7Ev-0r0LX41_-PKOHgJy" alt="Form Banner" class="app-banner img-fluid mb-3" onerror="this.onerror=null;this.src='https://placehold.co/1200x250/007bff/ffffff?text=Banner';">
            </div>
            <div class="text-center mb-4">
                <marquee behavior="scroll" direction="left" style="color:#000000; font-size: 15px;" onmouseover="this.stop();" onmouseout="this.start();"><h5><img src="https://lh5.googleusercontent.com/d/1cD2nVKNscJg1DJPnkaakah7Nz4ez_BZS" height="12" width="25"> ยินดีต้อนรับเข้าสู่ระบบจิตอาสาออนไลน์ โรงเรียนปากช่อง :: ออกแบบและพัฒนาโดย KT | Tanasarn Sirak <img src="https://lh5.googleusercontent.com/d/1cD2nVKNscJg1DJPnkaakah7Nz4ez_BZS" height="12" width="25"></h5></marquee>
                <p id="clock" class="bg-secondary text-white text-dark p-2 rounded shadow-sm">{{ clock }}</p>
            </div>

            <ul class="nav nav-tabs nav-fill mb-0" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" :class="{ 'active': activeTab === 'form' }" @click="activeTab = 'form'" type="button">
                        <i class="fas fa-edit me-2"></i>แบบฟอร์มบันทึก
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" :class="{ 'active': activeTab === 'search' }" @click="activeTab = 'search'" type="button">
                        <i class="fas fa-search me-2"></i>ค้นหารายบุคคล
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" :class="{ 'active': activeTab === 'stats' }" @click="loadStats" type="button">
                        <i class="fas fa-chart-pie me-2"></i>สถิติภาพรวม
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" :class="{ 'active': activeTab === 'history' }" @click="loadHistory" type="button">
                        <i class="fas fa-history me-2"></i>ประวัติการบันทึก
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade" :class="{ 'show active': activeTab === 'form' }">
                    <form @submit.prevent="submitForm" class="needs-validation" novalidate>
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <label class="form-label">ปีการศึกษา</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="academicYear" id="year2568" value="2568" v-model="formData.academicYear" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="year2568">2568</label>
                                    <input type="radio" class="btn-check" name="academicYear" id="year2569" value="2569" v-model="formData.academicYear" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="year2569">2569</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ภาคเรียน</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="semester" id="semester1" value="1" v-model="formData.semester" autocomplete="off" checked>
                                    <label class="btn btn-outline-primary" for="semester1">1</label>
                                    <input type="radio" class="btn-check" name="semester" id="semester2" value="2" v-model="formData.semester" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="semester2">2</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="activityDatePicker" class="form-label">วันที่ทำกิจกรรม</label>
                                <input type="text" id="activityDatePicker" class="form-control" placeholder="กรุณาเลือกวันที่..." required>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="classSelector" class="form-label">เลือกห้องเรียน</label>
                            <div class="input-group">
                                <select id="classSelector" class="form-control selectpicker" multiple data-live-search="true" title="กรุณาเลือกห้องเรียน..." @change="fetchStudents" v-model="selectedClasses">
                                   <option v-for="c in classes" :value="c">{{ c }}</option>
                                </select>
                                <button class="btn btn-outline-secondary" type="button" @click="resetClassSelection" title="รีเซตการเลือกห้อง">
                                    <i class="fas fa-undo"></i>
                                </button>
                            </div>
                        </div>

                        <div v-if="selectedClasses.length > 0">
                            <div class="mb-4" v-if="allFetchedStudents.length > 0">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                   <label class="form-label mb-0">รายชื่อนักเรียนที่เข้าร่วม (เลือกแล้ว {{ selectedStudentCount }} คน)</label>
                                   <div class="d-flex align-items-center">
                                       <div class="form-check form-switch me-3">
                                           <input class="form-check-input" type="checkbox" role="switch" id="hideSwitch" v-model="hideUnselected">
                                           <label class="form-check-label" for="hideSwitch">ซ่อน</label>
                                       </div>
                                       <div class="btn-group btn-group-sm">
                                           <button type="button" class="btn btn-sm btn-success" @click="selectAllStudents">ทั้งหมด</button>
                                           <button type="button" class="btn btn-sm btn-danger" @click="deselectAllStudents">ไม่เลือก</button>
                                       </div>
                                   </div>
                                </div>
                                <div class="list-group border rounded" style="max-height: 300px; overflow-y: auto;">
                                   <div v-for="student in filteredStudents" :key="student.id" class="list-group-item d-flex align-items-center p-2">
                                       <input class="form-check-input me-3" type="checkbox" v-model="student.selected" :id="'student-' + student.id" style="transform: scale(1.5);">
                                       <img :src="student.pictureUrl" class="student-avatar" alt="รูปนักเรียน" @error="imageError" @click="showStudentImage(student)">
                                       <div class="ms-3">
                                           <strong>{{ student.name }}</strong><br>
                                           <small class="text-muted">ห้อง {{ student.class }} เลขที่ {{ student.number }}</small>
                                       </div>
                                   </div>
                                </div>
                            </div>

                            <div class="row g-3 mb-4">
                                 <div class="col-md-6">
                                    <label for="activityName" class="form-label">ชื่อกิจกรรม</label>
                                    <input type="text" class="form-control" id="activityName" list="activityDatalist" v-model="formData.activityName" placeholder="เลือกหรือพิมพ์เพื่อเพิ่มกิจกรรม..." @focus="hideUnselected = true" required>
                                    <datalist id="activityDatalist">
                                        <option v-for="act in activityList" :value="act"></option>
                                    </datalist>
                                 </div>
                                 <div class="col-md-3">
                                    <label for="activityHours" class="form-label">จำนวนชั่วโมง</label>
                                    <input type="number" class="form-control" id="activityHours" v-model.number="formData.activityHours" min="1" required>
                                 </div>
                                 <div class="col-md-3">
                                     <label for="activityLocation" class="form-label">สถานที่</label>
                                     <input type="text" class="form-control" id="activityLocation" v-model="formData.activityLocation" required>
                                 </div>
                            </div>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="activityPhoto" class="form-label">ภาพกิจกรรม (1 ภาพ)</label>
                                    <input type="file" class="form-control" id="activityPhoto" @change="handlePhotoUpload" accept="image/*" required>
                                    <div v-if="activityPhotoPreview" class="mt-2 text-center">
                                        <img :src="activityPhotoPreview" class="img-fluid rounded border" alt="ตัวอย่างภาพกิจกรรม" style="max-height: 200px;">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="notes" class="form-label">หมายเหตุ</label>
                                    <textarea class="form-control" id="notes" rows="4" v-model="formData.notes"></textarea>
                                </div>
                            </div>

                            <hr class="my-4">

                            <h4 class="mb-3">การรับรองโดยครู</h4>
                            <div class="row g-3 align-items-center">
                                <div class="col-md-3" v-if="!teacherFound">
                                    <label for="teacherId" class="form-label">รหัสครู (4 หลัก)</label>
                                    <input type="password" class="form-control" id="teacherId" v-model="teacherId" @input="fetchTeacher" maxlength="4" placeholder="กรอกรหัส">
                                </div>
                                <div class="col-md-9" v-if="teacherFound">
                                    <div class="d-flex align-items-center bg-light p-3 rounded teacher-info">
                                        <img :src="formData.teacher.pictureUrl" alt="รูปครู" @error="imageError">
                                        <div class="ms-3">
                                            <h5 class="mb-0">{{ formData.teacher.name }}</h5>
                                            <p class="mb-0 text-muted">{{ formData.teacher.department }}</p>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-auto" @click="changeTeacher">แก้ไข</button>
                                    </div>
                                </div>
                            </div>

                            <div v-if="teacherFound">
                                <div class="row g-3 mt-3 justify-content-center">
                                    <div class="col-md-8 text-center">
                                        <label class="form-label">ลงลายมือชื่อผู้รับรอง</label>
                                        <div class="signature-pad-container" :class="{'is-invalid': signatureInvalid}">
                                            <canvas id="signature-pad"></canvas>
                                        </div>
                                        <div v-if="signatureInvalid" class="invalid-feedback d-block">
                                            กรุณาลงลายมือชื่อ
                                        </div>
                                        <button type="button" class="btn btn-sm btn-secondary mt-2" @click="clearSignature">
                                            <i class="fas fa-eraser"></i> ล้าง
                                        </button>
                                    </div>
                                </div>

                                <div class="text-center mt-5">
                                    <button type="submit" class="btn btn-primary btn-lg px-5" :disabled="isSubmitting">
                                        <span v-if="isSubmitting" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        <i class="fas fa-save me-2"></i>
                                        {{ isSubmitting ? 'กำลังบันทึก...' : 'บันทึกข้อมูล' }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="tab-pane fade" :class="{ 'show active': activeTab === 'search' }">
                    <h4 class="mb-3"><i class="fas fa-user-check me-2"></i>ค้นหาสถิติจิตอาสา (รายบุคคล)</h4>
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <div class="row g-2 justify-content-center">
                                <div class="col-md-5">
                                    <label for="searchStudentId" class="form-label fw-bold">กรอกรหัสนักเรียน (5 หลัก)</label>
                                    <input type="text" id="searchStudentId" class="form-control form-control-lg" v-model="search.studentId" maxlength="5" placeholder="เช่น 12345" @keyup.enter="searchStudentHistory">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary btn-lg w-100" @click="searchStudentHistory" :disabled="search.isSearching">
                                        <span v-if="search.isSearching" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        <i v-else class="fas fa-search"></i>
                                        ค้นหา
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="search.dataFound">
                        <div class="card shadow-sm mb-4 student-info-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <img :src="search.summary['รูป']" class="search-student-avatar me-4" alt="รูปนักเรียน" @error="imageError">
                                    <div>
                                        <h4 class="mb-1">{{ search.summary['ชื่อ สกุล'] }}</h4>
                                        <p class="mb-0 text-muted"><strong>ชั้น:</strong> {{ search.summary['ชั้น'] }} | <strong>เลขที่:</strong> {{ search.summary['เลขที่'] }} | <strong>รหัสประจำตัว:</strong> {{ search.summary['เลขประจำตัว'] }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h5 class="mt-4 mb-3"><i class="fas fa-clipboard-list me-2"></i>ตารางที่ 1: สรุปจำนวนจิตอาสา</h5>
                        <div class="table-responsive mb-5">
                            <table id="searchSummaryTable" class="table table-hover" style="width:100%">
                                <thead>
                                    <tr>
                                        <th class="text-center">เกณฑ์ชั่วโมงจิตอาสา</th>
                                        <th class="text-center">ชั่วโมงที่ทำแล้ว</th>
                                        <th class="text-center">ชั่วโมงที่ขาด</th>
                                        <th class="text-center">ผลการประเมิน</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="text-center align-middle">{{ search.summary['ชั่วโมงจิตอาสา'] }}</td>
                                        <td class="text-center align-middle">{{ search.summary['เวลาจิตอาสาที่ทำ'] }}</td>
                                        <td class="text-center align-middle">{{ search.summary['เวลาจิตอาสาที่ขาด'] }}</td>
                                        <td class="text-center align-middle">
                                            <span class="badge p-2" :class="getEvalBadgeClass(search.summary['ผลการประเมิน'])">
                                                {{ search.summary['ผลการประเมิน'] }}
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h5 class="mt-4 mb-3"><i class="fas fa-history me-2"></i>ตารางที่ 2: ข้อมูลการทำกิจกรรมจิตอาสา</h5>
                         <div class="table-responsive">
                            <table id="searchHistoryTable" class="table table-hover" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>วันที่ทำกิจกรรม</th>
                                        <th>รูปกิจกรรม</th>
                                        <th>ภาคเรียนที่</th>
                                        <th>ชื่อกิจกรรม</th>
                                        <th>จำนวนชั่วโมง</th>
                                        <th>ครูผู้รับรอง</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div v-if="search.noDataMessage" class="alert alert-warning text-center mt-4">
                        <i class="fas fa-exclamation-triangle me-2"></i> {{ search.noDataMessage }}
                    </div>
                </div>

                <div class="tab-pane fade" :class="{ 'show active': activeTab === 'stats' }">
                    <div class="row g-3 mb-4 text-center">
                        <div class="col-md-4">
                            <div class="card text-white bg-primary shadow">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-users me-2"></i>นักเรียนทั้งหมด</h5>
                                    <h2>{{ statsSummary.total }}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-white bg-success shadow">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-user-check me-2"></i>ผ่านการประเมิน</h5>
                                    <h2>{{ statsSummary.passed }}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-white bg-danger shadow">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-user-times me-2"></i>ไม่ผ่านการประเมิน</h5>
                                    <h2>{{ statsSummary.notPassed }}</h2>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label for="statsClassFilter" class="form-label fw-bold">กรองตามห้อง:</label>
                                    <select id="statsClassFilter" class="form-select" v-model="statsClassFilter">
                                        <option value="">ทุกห้อง</option>
                                        <option v-for="c in uniqueStatClasses" :key="c" :value="c">{{ c }}</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="statsResultFilter" class="form-label fw-bold">กรองตามผลการประเมิน:</label>
                                    <select id="statsResultFilter" class="form-select" v-model="statsResultFilter">
                                        <option value="">ทั้งหมด</option>
                                        <option value="✅ผ่าน">✅ผ่าน</option>
                                        <option value="❌ไม่ผ่าน">❌ไม่ผ่าน</option>
                                    </select>
                                </div>
                                <div class="col-md-4 d-flex justify-content-end">
                                    <button class="btn btn-info me-2" @click="refreshStats"><i class="fas fa-sync-alt me-1"></i> ดึงข้อมูลใหม่</button>
                                    <button class="btn btn-secondary" @click="resetStatsFilters"><i class="fas fa-undo me-1"></i> รีเซ็ตตัวกรอง</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table id="statsTable" class="table table-striped table-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th>รูป</th>
                                    <th>ชื่อ-สกุล</th>
                                    <th>ชั้น</th>
                                    <th>เลขที่</th>
                                    <th>ชม.ที่ผ่าน</th>
                                    <th>ทำแล้ว(ชม.)</th>
                                    <th>ผลประเมิน</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-pane fade" :class="{ 'show active': activeTab === 'history' }">
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h5 class="card-title mb-3"><i class="fas fa-filter me-2"></i>ตัวกรองข้อมูล</h5>
                            <div class="row g-3 align-items-end">
                                <div class="col-md-2">
                                    <label for="historyClassFilter" class="form-label fw-bold">กรองตามห้อง:</label>
                                    <select id="historyClassFilter" class="form-select" v-model="historyClassFilter">
                                        <option value="">ทุกห้อง</option>
                                        <option v-for="c in uniqueHistoryClasses" :key="c" :value="c">{{ c }}</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="historyTeacherFilterInput" class="form-label fw-bold">ครูผู้รับรอง:</label>
                                    <input class="form-control" list="teacherDatalist" id="historyTeacherFilterInput" placeholder="พิมพ์หรือเลือกครู..." v-model="historyTeacherFilter">
                                    <datalist id="teacherDatalist">
                                        <option v-for="t in uniqueHistoryTeachers" :key="t" :value="t"></option>
                                    </datalist>
                                </div>
                                <div class="col-md-4">
                                    <label for="historyDateFilter" class="form-label fw-bold">วันที่ทำกิจกรรม (จาก - ถึง):</label>
                                    <input type="text" id="historyDateFilter" class="form-control" placeholder="กรุณาเลือกช่วงวันที่...">
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-info me-2" @click="refreshHistory">
                                        <i class="fas fa-sync-alt me-1"></i> รีเฟรช
                                    </button>
                                    <button class="btn btn-secondary" @click="resetHistoryFilters">
                                        <i class="fas fa-undo me-1"></i> รีเซ็ต
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table id="historyTable" class="table table-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th>วันที่ทำกิจกรรม</th>
                                    <th>รูปกิจกรรม</th>
                                    <th>ภาคเรียนที่</th>
                                    <th>ชื่อกิจกรรม</th>
                                    <th>ชม.</th>
                                    <th>ชื่อ-สกุลนักเรียน</th>
                                    <th>ครูผู้รับรอง</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <footer class="text-center mt-5" style="background-color:#faf896; padding: 15px; border-radius: 0.5rem; font-size: 0.9em; color: #555;">
                :: Created and Developed by KT|Tanasarn Sirak ::
                <div class="mt-2">
                    <a href="https://line.me/ti/p/3F7VGrqgUr" target="_blank" class="text-decoration-none mx-2"><i class="fas fa-comment-dots"></i> สอบถาม/แจ้งปัญหา</a>
                    <span class="mx-2 text-muted">|</span>
                    <span class="text-black">KT | Tanasarn Sirak © <span id="current-year"></span></span>
                </div>
                <div class="mt-2">
                    :: จำนวนผู้ใช้งาน ::
                    <a href="https://www.freecounterstat.com" title="website counter"><img src="https://counter1.optistats.ovh/private/freecounterstat.php?c=uwgfnf4ee1nu15h57t14a9pnpf2h58za" border="0" title="website counter" alt="website counter"></a>
                </div>
            </footer>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/3.0.2/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.print.min.js"></script>

<script>
    function showStudentListModal(studentNamesCSV) {
        const studentList = studentNamesCSV.split(',').map(name => `<li class="list-group-item">${name.trim()}</li>`).join('');
        Swal.fire({
            title: 'รายชื่อนักเรียนที่เข้าร่วม',
            html: `<ul class="list-group text-start">${studentList}</ul>`,
            confirmButtonText: 'ปิด'
        });
    }

    function showStudentImageAlert(name, classInfo, number, imageUrl) {
        Swal.fire({
            title: name,
            text: `ห้อง ${classInfo} เลขที่ ${number}`,
            imageUrl: imageUrl,
            imageWidth: 200, imageHeight: 200, imageAlt: 'รูปของ ' + name,
        });
    }

    function showActivityImageAlert(activityName, imageUrl) {
        Swal.fire({
            text: `รูปกิจกรรม: ${activityName}`,
            imageUrl: imageUrl,
            width: '40%',
            imageAlt: 'รูปกิจกรรม ' + activityName,
        });
    }

    const { createApp } = Vue;

    const app = createApp({
        data() {
            return {
                webAppUrl: 'https://script.google.com/macros/s/AKfycbwy9vI0ZwCtECeDmmbo1fJjkJTAx4Rxlgob0KCD616hWfY4LL1x5BuXBRN2wDXTbbUr/exec',
                clock: '',
                activeTab: 'form',
                // Form Data
                classes: ['ม.1/1', 'ม.1/2', 'ม.1/3', 'ม.1/4', 'ม.1/5', 'ม.1/6', 'ม.1/7', 'ม.1/8', 'ม.1/9', 'ม.1/10', 'ม.1/11', 'ม.1/12', 'ม.1/13', 'ม.1/14', 'ม.2/1', 'ม.2/2', 'ม.2/3', 'ม.2/4', 'ม.2/5', 'ม.2/6', 'ม.2/7', 'ม.2/8', 'ม.2/9', 'ม.2/10', 'ม.2/11', 'ม.2/12', 'м.2/13', 'ม.3/1', 'м.3/2', 'м.3/3', 'м.3/4', 'м.3/5', 'м.3/6', 'м.3/7', 'м.3/8', 'м.3/9', 'м.3/10', 'м.3/11', 'м.3/12', 'м.3/13', 'м.3/14', 'м.4/1', 'м.4/2', 'м.4/3', 'м.4/4', 'м.4/5', 'м.4/6', 'м.4/7', 'м.4/8', 'м.4/9', 'м.4/10', 'м.4/11', 'м.4/12', 'м.4/13', 'м.4/14', 'м.5/1', 'м.5/2', 'м.5/3', 'м.5/4', 'м.5/5', 'м.5/6', 'м.5/7', 'м.5/8', 'м.5/9', 'м.5/10', 'м.5/11', 'м.5/12', 'м.5/13', 'м.5/14', 'м.6/1', 'м.6/2', 'м.6/3', 'м.6/4', 'м.6/5', 'м.6/6', 'м.6/7', 'м.6/8', 'м.6/9', 'м.6/10', 'м.6/11', 'м.6/12', 'м.6/13', 'м.6/14'],
                activityList: [],
                selectedClasses: [],
                allFetchedStudents: [],
                hideUnselected: false,
                activityPhotoPreview: null,
                formData: {
                    academicYear: '2568', semester: '1', activityDate: new Date().toISOString().slice(0, 10),
                    activityName: '', activityHours: 1, activityLocation: 'โรงเรียนปากช่อง', notes: '',
                    teacher: {}, signature: null, activityPhoto: null,
                },
                teacherId: '',
                teacherFound: false,
                signaturePad: null,
                signatureInvalid: false,
                isSubmitting: false,
                 // Search Tab Data
                search: {
                    studentId: '',
                    isSearching: false,
                    dataFound: false,
                    noDataMessage: '',
                    summary: {},
                    activities: [],
                    historyTable: null,
                },
                // Stats Data
                statsData: [],
                statsClassFilter: '',
                statsResultFilter: '',
                statsLoaded: false,
                dataTable: null,
                // History Data
                historyData: [],
                historyLoaded: false,
                historyDataTable: null,
                historyClassFilter: '',
                historyTeacherFilter: '',
                historyDateRange: [],
            };
        },
        computed: {
            selectedStudentCount() {
                return this.allFetchedStudents.filter(s => s.selected).length;
            },
            filteredStudents() {
                return this.hideUnselected ? this.allFetchedStudents.filter(s => s.selected) : this.allFetchedStudents;
            },
            statsSummary() {
                let dataSource = this.statsData;
                if (this.statsClassFilter) {
                    dataSource = this.statsData.filter(student => student.class === this.statsClassFilter);
                }
                const total = dataSource.length;
                const passed = dataSource.filter(s => s.result === '✅ผ่าน').length;
                const notPassed = dataSource.filter(s => s.result === '❌ไม่ผ่าน').length;
                return { total, passed, notPassed };
            },
            uniqueStatClasses() {
                const classSet = new Set(this.statsData.map(s => s.class));
                return Array.from(classSet).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
            },
            uniqueHistoryClasses() {
                const classSet = new Set();
                this.historyData.forEach(row => {
                    const classes = row['ห้อง'] ? row['ห้อง'].split(',') : [];
                    classes.forEach(c => classSet.add(c.trim()));
                });
                return Array.from(classSet).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
            },
            uniqueHistoryTeachers() {
                const teacherSet = new Set(this.historyData.map(row => row['ครูผู้รับรอง']).filter(Boolean));
                return Array.from(teacherSet).sort();
            }
        },
        watch: {
            teacherFound(newVal) {
                if (newVal) {
                    this.$nextTick(() => this.initSignaturePad());
                }
            },
            statsClassFilter() {
                if(this.dataTable) this.dataTable.draw();
            },
            statsResultFilter() {
                if(this.dataTable) this.dataTable.draw();
            },
            historyClassFilter() {
                if(this.historyDataTable) this.historyDataTable.draw();
            },
            historyTeacherFilter() {
                if(this.historyDataTable) this.historyDataTable.draw();
            }
        },
        methods: {
            updateClock() {
                 const now = new Date();
                const days = ['วันอาทิตย์', 'วันจันทร์', 'วันอังคาร', 'วันพุธ', 'วันพฤหัสบดี', 'วันศุกร์', 'วันเสาร์'];
                const months = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
                const dayName = days[now.getDay()];
                const day = now.getDate();
                const monthName = months[now.getMonth()];
                const year = now.getFullYear() + 543;
                const time = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                this.clock = `${dayName}ที่ ${day} ${monthName} พ.ศ. ${year} เวลา ${time.replace(/:/g, ' : ')} น.`;
            },
            imageError(event) {
                event.target.src = 'https://placehold.co/80x80/EFEFEF/AAAAAA?text=N/A';
            },
            async fetchStudents() {
                if (this.selectedClasses.length === 0) {
                    this.allFetchedStudents = [];
                    return;
                }
                $.LoadingOverlay("show");
                const requests = this.selectedClasses.map(c => fetch(`${this.webAppUrl}?action=getStudents&class=${encodeURIComponent(c)}`).then(res => res.json()));
                try {
                    const results = await Promise.all(requests);
                    let allStudents = [];
                    results.forEach(result => {
                       if (result.success) allStudents = [...allStudents, ...result.data];
                    });
                    const uniqueStudents = Array.from(new Map(allStudents.map(item => [item['id'], item])).values());
                    this.allFetchedStudents = uniqueStudents.map(s => ({ ...s, selected: true }));
                } catch (error) {
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลนักเรียนได้', 'error');
                } finally {
                    $.LoadingOverlay("hide");
                }
            },
            async fetchTeacher() {
                this.teacherFound = false;
                this.formData.teacher = {};
                if (this.teacherId.length < 4) return;
                $.LoadingOverlay("show");
                try {
                    const res = await fetch(`${this.webAppUrl}?action=getTeacher&id=${this.teacherId}`);
                    const result = await res.json();
                    if (result.success) {
                        this.formData.teacher = result.data;
                        this.teacherFound = true;
                        Swal.fire({ icon: 'success', title: 'พบข้อมูลครู', text: `ชื่อ: ${result.data.name}`, timer: 1500, showConfirmButton: false });
                    } else {
                         Swal.fire('ไม่พบข้อมูล', 'ไม่พบข้อมูลครูสำหรับรหัสนี้', 'warning');
                    }
                } catch (error) {
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้', 'error');
                } finally {
                    $.LoadingOverlay("hide");
                }
            },
            changeTeacher() {
                this.teacherFound = false;
                this.teacherId = '';
                this.formData.teacher = {};
            },
            resetClassSelection() {
                this.selectedClasses = [];
                this.allFetchedStudents = [];
                if ($('.selectpicker').length) {
                    $('.selectpicker').selectpicker('val', []);
                }
            },
            async fetchActivities() {
                try {
                    const res = await fetch(`${this.webAppUrl}?action=getActivities`);
                    const result = await res.json();
                    if (result.success) this.activityList = result.data;
                } catch (error) { console.error('Error fetching activities:', error); }
            },
            handlePhotoUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    this.formData.activityPhoto = file;
                    this.activityPhotoPreview = URL.createObjectURL(file);
                }
            },
            initSignaturePad() {
                const canvas = document.getElementById('signature-pad');
                this.signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)', onEnd: () => { this.signatureInvalid = false; } });
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                this.signaturePad.clear();
            },
            clearSignature() {
                if(this.signaturePad) this.signaturePad.clear();
            },
            selectAllStudents() { this.allFetchedStudents.forEach(s => s.selected = true); },
            deselectAllStudents() { this.allFetchedStudents.forEach(s => s.selected = false); },
            showStudentImage(student) {
                showStudentImageAlert(student.name, student.class, student.number, student.pictureUrl);
            },
            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
            },
            resetForm() {
                const form = document.querySelector('.needs-validation');
                if(form) form.classList.remove('was-validated');

                this.formData.academicYear = '2568';
                this.formData.semester = '1';
                const today = new Date().toISOString().slice(0, 10);
                this.formData.activityDate = today;
                flatpickr("#activityDatePicker").setDate(today, true);

                this.formData.activityName = '';
                this.formData.activityHours = 1;
                this.formData.activityLocation = 'โรงเรียนปากช่อง';
                this.formData.notes = '';
                this.formData.teacher = {};
                this.formData.signature = null;
                this.formData.activityPhoto = null;
                this.activityPhotoPreview = null;
                const photoInput = document.getElementById('activityPhoto');
                if(photoInput) photoInput.value = '';

                this.resetClassSelection();
                this.hideUnselected = false;

                this.teacherId = '';
                this.teacherFound = false;
                this.signatureInvalid = false;
                if (this.signaturePad) {
                    this.clearSignature();
                }
            },
            async submitForm(event) {
                const form = event.target;
                const selectedStudents = this.allFetchedStudents.filter(s => s.selected);
                this.signatureInvalid = (this.signaturePad && this.signaturePad.isEmpty());

                if (!form.checkValidity() || selectedStudents.length === 0 || !this.teacherFound || this.signatureInvalid) {
                    form.classList.add('was-validated');
                    Swal.fire('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน, เลือกนักเรียน, และลงลายมือชื่อผู้รับรอง', 'error');
                    return;
                }

                const formattedDate = document.getElementById('activityDatePicker')._flatpickr.altInput.value;
                const studentListHtml = selectedStudents.map(s => `<li>${s.name}</li>`).join('');

                const confirmationResult = await Swal.fire({
                    title: 'ยืนยันการบันทึกข้อมูล',
                    html: `
                        <div class="table-responsive text-start" style="max-width: 100%; overflow-x: auto;">
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <th style="width: 30%; white-space: nowrap;">วันที่ทำกิจกรรม</th>
                                        <td>${formattedDate}</td>
                                    </tr>
                                    <tr>
                                        <th style="white-space: nowrap;">ชื่อกิจกรรม</th>
                                        <td>${this.formData.activityName}</td>
                                    </tr>
                                    <tr>
                                        <th style="white-space: nowrap;">จำนวนชั่วโมง</th>
                                        <td>${this.formData.activityHours}</td>
                                    </tr>
                                    <tr>
                                        <th style="white-space: nowrap;">นักเรียนที่เข้าร่วม (${selectedStudents.length} คน)</th>
                                        <td><ul class="list-unstyled mb-0" style="max-height: 150px; overflow-y: auto;">${studentListHtml}</ul></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `,
                    icon: 'info',
                    width: '50rem',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#dc3545',
                    confirmButtonText: '<i class="fas fa-check-circle"></i> ยืนยัน',
                    cancelButtonText: '<i class="fas fa-times-circle"></i> ยกเลิก'
                });

                if (confirmationResult.isConfirmed) {
                    this.isSubmitting = true;
                    $.LoadingOverlay("show");
                    try {
                        const photoBase64 = await this.fileToBase64(this.formData.activityPhoto);
                        const signatureBase64 = this.signaturePad.toDataURL('image/png').split(',')[1];
                        const postData = new FormData();
                        Object.keys(this.formData).forEach(key => {
                            if (key !== 'teacher' && key !== 'activityPhoto') {
                               postData.append(key, typeof this.formData[key] === 'object' ? JSON.stringify(this.formData[key]) : this.formData[key]);
                            }
                        });
                        postData.append('teacher', JSON.stringify(this.formData.teacher));
                        postData.append('students', JSON.stringify(selectedStudents));
                        postData.append('photoBase64', photoBase64);
                        postData.append('photoFileName', `photo_${Date.now()}.jpg`);
                        postData.append('signatureBase64', signatureBase64);
                        postData.append('signatureFileName', `sig_${Date.now()}.png`);

                        const response = await fetch(this.webAppUrl, { method: 'POST', body: postData });
                        const result = await response.json();
                        
                        $.LoadingOverlay("hide");
                        this.isSubmitting = false;

                        if (result.success) {
                             await Swal.fire({
                                title: 'บันทึกสำเร็จ!',
                                icon: 'success',
                                html: `
                                    <p class="mb-3">ข้อมูลกิจกรรมของท่านถูกบันทึกเรียบร้อยแล้ว</p>
                                    <div class="table-responsive text-start" style="max-width: 100%; overflow-x: auto;">
                                        <table class="table table-bordered">
                                            <tbody>
                                                <tr>
                                                    <th style="width: 30%; white-space: nowrap;">วันที่ทำกิจกรรม</th>
                                                    <td>${formattedDate}</td>
                                                </tr>
                                                <tr>
                                                    <th style="white-space: nowrap;">ชื่อกิจกรรม</th>
                                                    <td>${this.formData.activityName}</td>
                                                </tr>
                                                <tr>
                                                    <th style="white-space: nowrap;">จำนวนชั่วโมง</th>
                                                    <td>${this.formData.activityHours}</td>
                                                </tr>
                                                <tr>
                                                    <th style="white-space: nowrap;">นักเรียนที่เข้าร่วม (${selectedStudents.length} คน)</th>
                                                    <td><ul class="list-unstyled mb-0" style="max-height: 150px; overflow-y: auto;">${studentListHtml}</ul></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                `,
                                confirmButtonText: 'ตกลง',
                                allowOutsideClick: false
                            });
                            
                            this.resetForm();
                            this.activeTab = 'history';
                            this.historyLoaded = false;
                            this.loadHistory();

                        } else {
                            throw new Error(result.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                        }
                    } catch (error) {
                        $.LoadingOverlay("hide");
                        this.isSubmitting = false;
                        Swal.fire('เกิดข้อผิดพลาด!', error.message, 'error');
                    }
                }
            },
             getEvalBadgeClass(result) {
                if (result === '✅ผ่าน') return 'bg-success';
                if (result === '❌ไม่ผ่าน') return 'bg-danger';
                return 'bg-warning text-dark';
            },

            async searchStudentHistory() {
                if (!this.search.studentId || this.search.studentId.length < 5) {
                    Swal.fire('ข้อมูลไม่ถูกต้อง', 'กรุณากรอกรหัสนักเรียน 5 หลักให้ถูกต้อง', 'warning');
                    return;
                }

                this.search.isSearching = true;
                this.search.dataFound = false;
                this.search.noDataMessage = '';
                if (this.search.historyTable) {
                    this.search.historyTable.destroy();
                    $('#searchHistoryTable tbody').empty();
                    this.search.historyTable = null;
                }
                
                $.LoadingOverlay("show");

                try {
                    const res = await fetch(`${this.webAppUrl}?action=getStudentHistory&studentId=${this.search.studentId}`);
                    const result = await res.json();

                    if (result.success) {
                        this.search.summary = result.data.summary;
                        this.search.activities = result.data.activities;
                        this.search.dataFound = true;
                        
                        this.$nextTick(() => {
                            this.initSearchHistoryTable();
                        });

                    } else {
                        this.search.noDataMessage = result.message || 'ไม่พบข้อมูลนักเรียนรหัสนี้';
                    }
                } catch (error) {
                    this.search.noDataMessage = 'เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์';
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถดึงข้อมูลได้', 'error');
                } finally {
                    this.search.isSearching = false;
                    $.LoadingOverlay("hide");
                }
            },
            initSearchHistoryTable() {
                if ($.fn.DataTable.isDataTable('#searchHistoryTable')) {
                   $('#searchHistoryTable').DataTable().destroy();
                }
                 this.search.historyTable = new DataTable('#searchHistoryTable', {
                    responsive: true,
                    data: this.search.activities,
                    dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                         "<'row'<'col-sm-12'tr>>" +
                         "<'row'<'col-sm-12 col-md'i><'col-sm-12 col-md-auto'p>>",
                    columns: [
                        { 
                            data: 'วันที่ทำกิจกรรม', 
                            className: 'text-center align-middle',
                            render: function(data, type, row) {
                                if (type === 'display' && typeof data === 'string' && data.includes('-')) {
                                    try {
                                        const thaiMonths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
                                        const datePart = data.split('T')[0];
                                        const parts = datePart.split('-');
                                        
                                        if (parts.length === 3) {
                                            const year = parts[0]; 
                                            const monthIndex = parseInt(parts[1], 10) - 1;
                                            const day = parseInt(parts[2], 10);

                                            if (!isNaN(day) && !isNaN(monthIndex) && monthIndex >= 0 && monthIndex < 12) {
                                                const month = thaiMonths[monthIndex];
                                                return `${day} ${month}.${year}`;
                                            }
                                        }
                                    } catch (e) {
                                       return data;
                                    }
                                } else if (type === 'display' && data) {
                                    return String(data).replace(/ (\d{4})$/, '.$1');
                                }
                                return data;
                            }
                        },
                        { 
                            data: 'ลิงก์รูปกิจกรรม', 
                            orderable: false, 
                            className: 'text-center align-middle',
                            render: (data, type, row) => data ? `<img src="${data}" class="history-activity-image" alt="รูปกิจกรรม" onclick="showActivityImageAlert('${String(row['ชื่อกิจกรรม']).replace(/'/g, "\\'")}', '${data}')" onerror="this.onerror=null;this.src='https://placehold.co/80x80/EFEFEF/AAAAAA?text=N/A';">` : ''
                        },
                        {
                            data: null, 
                            className: 'text-center align-middle',
                            render: (data, type, row) => `${row['ภาคเรียน']}/${row['ปีการศึกษา']}`
                        },
                        { data: 'ชื่อกิจกรรม', className: 'align-middle' },
                        { data: 'จำนวนชั่วโมง', className: 'text-center align-middle' },
                        { data: 'ครูผู้รับรอง', className: 'align-middle' }
                    ],
                    language: { url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/th.json' },
                    order: [],
                });
            },
            async loadStats() {
                this.activeTab = 'stats';
                if (this.statsLoaded) return;
                $.LoadingOverlay("show");
                try {
                    const res = await fetch(`${this.webAppUrl}?action=getStudentStats`);
                    const result = await res.json();
                    if (result.success) {
                        this.statsData = result.data;
                        this.statsLoaded = true;
                        this.$nextTick(() => this.initDataTable());
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    Swal.fire('เกิดข้อผิดพลาด', `ไม่สามารถโหลดข้อมูลสถิติได้: ${error.message}`, 'error');
                } finally {
                    $.LoadingOverlay("hide");
                }
            },
            refreshStats() {
                this.statsLoaded = false;
                this.loadStats();
            },
            resetStatsFilters() {
                this.statsClassFilter = '';
                this.statsResultFilter = '';
            },
            initDataTable() {
                if (this.dataTable) this.dataTable.destroy();
                
                $.fn.dataTable.ext.search.push((settings, data, dataIndex) => {
                    if (settings.nTable.id !== 'statsTable') return true;
                    if (!this.statsData[dataIndex]) return false;
                    const classFilter = this.statsClassFilter;
                    const resultFilter = this.statsResultFilter;
                    const studentClass = this.statsData[dataIndex].class;
                    const studentResult = this.statsData[dataIndex].result;
                    if ((!classFilter || studentClass === classFilter) && (!resultFilter || studentResult === resultFilter)) {
                        return true;
                    }
                    return false;
                });

                this.dataTable = new DataTable('#statsTable', {
                    responsive: true,
                    data: this.statsData,
                    dom: "<'row'<'col-sm-12 col-md-4'l><'col-sm-12 col-md-4'B><'col-sm-12 col-md-4'f>>" +
                         "<'row'<'col-sm-12'tr>>" +
                         "<'row'<'col-sm-12 col-md'i><'col-sm-12 col-md-auto'p>>",
                    buttons: [
                        { extend: 'copy', text: '<i class="fas fa-copy"></i> คัดลอก', className: 'btn-warning' },
                        { extend: 'excel', text: '<i class="fas fa-file-excel"></i> Excel', className: 'btn-primary' },
                        { extend: 'print', text: '<i class="fas fa-print"></i> พิมพ์', className: 'btn-info' }
                    ],
                    columns: [
                        { 
                            data: 'pictureUrl', orderable: false, className: 'text-center',
                            render: (data, type, row) => `<img src="${data}" class="stats-student-avatar" alt="รูป" onclick="showStudentImageAlert('${row.name.replace(/'/g, "\\'")}', '${row.class}', '${row.number}', '${data}')" onerror="this.onerror=null;this.src='https://placehold.co/80x80/EFEFEF/AAAAAA?text=N/A';">`
                        },
                        { data: 'name' },
                        { data: 'class', className: 'text-center' },
                        { data: 'number', className: 'text-center' },
                        { data: 'hours_passed', className: 'text-center' },
                        { data: 'hours_done', className: 'text-center' },
                        { 
                            data: 'result', className: 'text-center',
                            render: (data) => {
                                let badgeClass = 'bg-secondary';
                                if (data === '✅ผ่าน') badgeClass = 'bg-success';
                                else if (data === '❌ไม่ผ่าน') badgeClass = 'bg-danger';
                                else if (data === 'รอประเมิน') badgeClass = 'bg-warning text-dark';
                                return `<span class="badge ${badgeClass} p-2">${data}</span>`;
                            }
                        }
                    ],
                    language: { url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/th.json' },
                    order: [[2, 'asc'], [3, 'asc']]
                });
            },
            refreshHistory() {
                this.historyLoaded = false;
                this.loadHistory();
            },
            resetHistoryFilters() {
                this.historyClassFilter = '';
                this.historyTeacherFilter = '';
                this.historyDateRange = [];
                const historyDatePicker = document.querySelector("#historyDateFilter")._flatpickr;
                if (historyDatePicker) {
                    historyDatePicker.clear();
                }
                if (this.historyDataTable) {
                    this.historyDataTable.draw();
                }
            },
            async loadHistory() {
                this.activeTab = 'history';
                if (this.historyLoaded) return;
                $.LoadingOverlay("show");
                try {
                    const res = await fetch(`${this.webAppUrl}?action=getHistory`);
                    const result = await res.json();
                    if (result.success) {
                        if (result.data.length > 0 && result.data[0].Timestamp) {
                            this.historyData = result.data.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
                        } else {
                            this.historyData = result.data.reverse();
                        }
                        this.historyLoaded = true;
                        this.$nextTick(() => this.initHistoryTable());
                    } else {
                        throw new Error(result.message || 'Unknown error');
                    }
                } catch (error) {
                    Swal.fire('เกิดข้อผิดพลาด', `ไม่สามารถโหลดข้อมูลประวัติได้: ${error.message}`, 'error');
                } finally {
                    $.LoadingOverlay("hide");
                }
            },
            initHistoryTable() {
                if (this.historyDataTable) {
                    this.historyDataTable.destroy();
                    $('#historyTable tbody').empty();
                }

                $.fn.dataTable.ext.search.push((settings, data, dataIndex) => {
                    if (settings.nTable.id !== 'historyTable') return true;
                    const rowData = this.historyData[dataIndex];
                    if (!rowData) return false;
                    
                    const classFilter = this.historyClassFilter;
                    const rowClasses = rowData['ห้อง'] ? rowData['ห้อง'].toString().split(',') : [];
                    if (classFilter && !rowClasses.some(c => c.trim() === classFilter)) return false;

                    const teacherFilter = this.historyTeacherFilter;
                    if (teacherFilter && rowData['ครูผู้รับรอง'] && !rowData['ครูผู้รับรอง'].includes(teacherFilter)) {
                        return false;
                    }

                    const dateRange = this.historyDateRange;
                    if(dateRange.length === 2) {
                        const thaiMonths = {'ม.ค.':0, 'ก.พ.':1, 'มี.ค.':2, 'เม.ย.':3, 'พ.ค.':4, 'มิ.ย.':5, 'ก.ค.':6, 'ส.ค.':7, 'ก.ย.':8, 'ต.ค.':9, 'พ.ย.':10, 'ธ.ค.':11};
                        const dateParts = rowData['วันที่ทำกิจกรรม'].split(' ');
                        const rowDate = new Date(parseInt(dateParts[2]) - 543, thaiMonths[dateParts[1]], parseInt(dateParts[0]));
                        if (rowDate < dateRange[0] || rowDate > dateRange[1]) return false;
                    }
                    return true;
                });
                
                this.historyDataTable = new DataTable('#historyTable', {
                    responsive: true,
                    data: this.historyData,
                    dom: "<'row'<'col-sm-12 col-md-4'l><'col-sm-12 col-md-4'B><'col-sm-12 col-md-4'f>>" +
                         "<'row'<'col-sm-12'tr>>" +
                         "<'row'<'col-sm-12 col-md'i><'col-sm-12 col-md-auto'p>>",
					buttons: [
                        { extend: 'copy', text: '<i class="fas fa-copy"></i> คัดลอก', className: 'btn-warning' },
                        { extend: 'excel', text: '<i class="fas fa-file-excel"></i> Excel', className: 'btn-primary' },
                        { extend: 'print', text: '<i class="fas fa-print"></i> พิมพ์', className: 'btn-info' }
                    ],	 	 
                    columns: [
						{ data: 'วันที่ทำกิจกรรม', className: 'text-center align-middle' },
                        { 
                            data: 'ลิงก์รูปกิจกรรม', orderable: false, className: 'text-center align-middle',
                            render: (data, type, row) => data ? `<img src="${data}" class="history-activity-image" alt="รูปกิจกรรม" onclick="showActivityImageAlert('${String(row['ชื่อกิจกรรม']).replace(/'/g, "\\'")}', '${data}')" onerror="this.onerror=null;this.src='https://placehold.co/80x80/EFEFEF/AAAAAA?text=N/A';">` : ''
                        },
                        
                        {
                            data: null, className: 'text-center align-middle',
                            render: (data, type, row) => `${row['ภาคเรียน']}/${row['ปีการศึกษา']}`
                        },
                        { data: 'ชื่อกิจกรรม', className: 'align-middle' },
                        { data: 'จำนวนชั่วโมง', className: 'text-center align-middle' },
                        { 
                            data: 'ชื่อ-สกุลนักเรียน', 
                            className: 'align-middle text-center',
                            orderable: false,
                            render: function(data, type, row) {
                                const names = String(data).replace(/'/g, "\\'");
                                return `<button type="button" class="btn btn-sm btn-outline-primary" onclick="showStudentListModal(\`${names}\`)">ดูรายชื่อ</button>`;
                            }
                        },
                        { data: 'ครูผู้รับรอง', className: 'align-middle' }
                    ],
                    language: { 
                        url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/th.json',
                        search: "ค้นหาด้วยชื่อนักเรียน:"
                    },
                    order: [],
                });
            }
        },
        mounted() {
            $.LoadingOverlaySetup({
                background: "rgba(0, 0, 0, 0.6)", image: "https://media1.giphy.com/media/mBMdeZHp6bqfkL4vBI/giphy.gif",
                imageAnimation: "none", size: 150,
            });

            this.updateClock();
            setInterval(this.updateClock, 1000);
            document.getElementById('current-year').textContent = (new Date().getFullYear() + 543);
            
                 // Initialize Flatpickr
                 flatpickr("#activityDatePicker", {
                    locale: "th",
                    altInput: true,
                    dateFormat: "Y-m-d", // for backend
                    defaultDate: this.formData.activityDate,
                    onReady: (selectedDates, dateStr, instance) => {
                        if (instance.altInput) {
                            const date = selectedDates.length > 0 ? selectedDates[0] : new Date();
                            const thaiYear = date.getFullYear() + 543;
                            instance.altInput.value = `${instance.formatDate(date, "j M")} ${thaiYear}`;
                        }
                    },
                    onChange: (selectedDates, dateStr, instance) => {
                        this.formData.activityDate = dateStr;
                        if (instance.altInput && selectedDates.length > 0) {
                            const date = selectedDates[0];
                            const thaiYear = date.getFullYear() + 543;
                            instance.altInput.value = `${instance.formatDate(date, "j M")} ${thaiYear}`;
                        }
                    },
                });


            flatpickr("#historyDateFilter", {
                mode: "range",
                locale: "th",
                dateFormat: "Y-m-d",
                onClose: (selectedDates) => {
                    if (selectedDates.length === 2) {
                        selectedDates[0].setHours(0, 0, 0, 0);
                        selectedDates[1].setHours(23, 59, 59, 999);
                        this.historyDateRange = selectedDates;
                    } else if (selectedDates.length === 0) {
                        this.historyDateRange = [];
                    }
                    if (this.historyDataTable) this.historyDataTable.draw();
                }
            });

            this.$nextTick(() => { 
                $('.selectpicker').selectpicker(); 
            });
            this.fetchActivities();
        },
        beforeUnmount() {
           $.fn.dataTable.ext.search.pop();
           $.fn.dataTable.ext.search.pop();
        },
    });

    app.config.compilerOptions.isCustomElement = (tag) => tag === 'marquee';
    app.mount('#app');
</script>

</body>
</html>
